<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–¢–æ–ª—å–∫–æ —á–∞—Ç | StreamCast</title>
		<link rel="stylesheet" href="style.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<div class="room-container">
			<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–Ω–∞—Ç—ã -->
			<header class="room-header">
				<div class="room-header-content">
					<div class="room-title">
						<i class="fas fa-comment"></i>
						<h1>–¢–æ–ª—å–∫–æ —á–∞—Ç</h1>
					</div>
					<div class="room-id-display" id="roomIdDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
					<div class="room-stats">
						<i class="fas fa-users"></i>
						<span id="participantCount">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
					</div>
					<div>
						<a href="/" class="btn btn-secondary">
							<i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è
						</a>
						<a href="#" id="viewerLink" class="btn btn-secondary">
							<i class="fas fa-video"></i> –°–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
						</a>
					</div>
				</div>
			</header>

			<!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
			<main class="room-main" style="grid-template-columns: 1fr">
				<!-- –ß–∞—Ç -->
				<section class="chat-section">
					<div class="chat-header">
						<h3><i class="fas fa-comments"></i> –ß–∞—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏</h3>
						<div class="chat-info">
							<span id="chatStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
						</div>
					</div>

					<div class="chat-messages" id="chatMessages">
						<div class="message system">
							<i class="fas fa-spinner fa-spin"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É...
						</div>
					</div>

					<div class="chat-input-area">
						<input
							type="text"
							id="usernameInput"
							class="chat-input"
							placeholder="–í–∞—à–µ –∏–º—è"
							value="–£—á–∞—Å—Ç–Ω–∏–∫"
							maxlength="20"
						/>
						<input
							type="text"
							id="chatInput"
							class="chat-input"
							placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
							maxlength="500"
						/>
						<button onclick="sendMessage()" class="btn btn-primary">
							<i class="fas fa-paper-plane"></i>
						</button>
					</div>
				</section>
			</main>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			const urlParams = new URLSearchParams(window.location.search);
			const roomId = urlParams.get("room");
			const username = urlParams.get("username") || "–£—á–∞—Å—Ç–Ω–∏–∫";

			let socket = null;
			let participantCount = 0;

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
			async function init() {
				if (!roomId) {
					showError("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞");
					setTimeout(() => (window.location.href = "/"), 2000);
					return;
				}

				document.getElementById("roomIdDisplay").textContent = roomId;
				document.getElementById(
					"viewerLink"
				).href = `/viewer.html?room=${roomId}&username=${username}`;

				connectWebSocket();
				setupEventListeners();
			}

			// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
			function connectWebSocket() {
				socket = io();

				socket.on("connect", () => {
					console.log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É");
					updateChatStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É...");

					// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
					socket.emit("join_room", {
						roomId: roomId,
						username: username,
						isViewer: true,
					});
				});

				socket.on("room_joined", (data) => {
					console.log("‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ:", data);
					participantCount = data.participantCount;
					updateParticipantCount();
					updateChatStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
					addChatMessage("–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ —á–∞—Ç—É", "system");
				});

				socket.on("participant_joined", (data) => {
					console.log("üë• –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:", data);
					participantCount = data.participantCount;
					updateParticipantCount();
					addChatMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, "system");
				});

				socket.on("participant_left", (data) => {
					console.log("üëã –£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª:", data);
					participantCount = data.participantCount;
					updateParticipantCount();
					addChatMessage(`${data.username} –≤—ã—à–µ–ª`, "system");
				});

				socket.on("chat_message", (message) => {
					if (message.type === "message") {
						addChatMessage(message.message, "remote", message.username);
					} else if (message.type === "system") {
						addChatMessage(message.message, "system");
					}
				});

				socket.on("chat_history", (data) => {
					data.messages.forEach((msg) => {
						if (msg.type === "message") {
							addChatMessage(msg.message, "remote", msg.username);
						}
					});
				});

				socket.on("host_disconnected", () => {
					showError("–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è");
					updateChatStatus("–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è", "error");
				});

				socket.on("disconnect", () => {
					updateChatStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ", "error");
				});
			}

			// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
			function sendMessage() {
				const input = document.getElementById("chatInput");
				const usernameInput = document.getElementById("usernameInput");
				const message = input.value.trim();
				const currentUsername = usernameInput.value.trim() || "–£—á–∞—Å—Ç–Ω–∏–∫";

				if (!message || !socket) return;

				socket.emit("chat_message", {
					roomId: roomId,
					message: message,
				});

				addChatMessage(message, "local", currentUsername);
				input.value = "";
				input.focus();
			}

			// –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
			function addChatMessage(text, type, sender = "–°–∏—Å—Ç–µ–º–∞") {
				const messagesDiv = document.getElementById("chatMessages");
				const messageDiv = document.createElement("div");

				messageDiv.className = `message ${type}`;

				const time = new Date().toLocaleTimeString([], {
					hour: "2-digit",
					minute: "2-digit",
				});

				if (type === "system") {
					messageDiv.innerHTML = `
                    <div class="message-text">${text}</div>
                    <div class="message-time">${time}</div>
                `;
				} else {
					messageDiv.innerHTML = `
                    <div class="message-sender">${sender}</div>
                    <div class="message-text">${text}</div>
                    <div class="message-time">${time}</div>
                `;
				}

				messagesDiv.appendChild(messageDiv);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}

			// –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
			function updateParticipantCount() {
				const text =
					participantCount === 1 ? "1 —É—á–∞—Å—Ç–Ω–∏–∫" : `${participantCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
				document.getElementById("participantCount").textContent = text;
			}

			// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞
			function updateChatStatus(status, type = "info") {
				const statusElement = document.getElementById("chatStatus");
				statusElement.textContent = status;
				statusElement.className = type;
			}

			// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
			function showError(message) {
				addChatMessage(message, "system error");
			}

			// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
			function setupEventListeners() {
				// –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
				document.getElementById("chatInput").addEventListener("keypress", (e) => {
					if (e.key === "Enter") {
						sendMessage();
					}
				});

				// –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
				document.getElementById("usernameInput").addEventListener("change", function () {
					if (!this.value.trim()) {
						this.value = "–£—á–∞—Å—Ç–Ω–∏–∫";
					}
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
				window.addEventListener("beforeunload", () => {
					if (socket) socket.disconnect();
				});
			}

			// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
			window.addEventListener("load", init);

			// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
			const style = document.createElement("style");
			style.textContent = `
            .chat-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .chat-info {
                font-size: 0.9rem;
                color: var(--gray);
            }
            
            #chatStatus.success {
                color: #10b981;
            }
            
            #chatStatus.error {
                color: #ef4444;
            }
            
            #chatStatus.info {
                color: #6366f1;
            }
            
            .message.system.error {
                background: rgba(239, 68, 68, 0.2);
                border-color: rgba(239, 68, 68, 0.3);
                color: #ef4444;
            }
            
            .chat-input-area {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            @media (max-width: 768px) {
                .chat-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
            }
        `;
			document.head.appendChild(style);
		</script>
	</body>
</html>
