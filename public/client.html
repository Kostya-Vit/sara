<!DOCTYPE html>
<html lang="uk">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>Учасник | Перегляд Трансляції</title>
		<style>
			/* === БАЗОВЫЕ СТИЛИ === */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
				background: #0f172a;
				color: white;
				/* УБРАНО: min-height: 100vh; - это создает проблемы на мобильных с клавиатурой */
				display: flex;
				flex-direction: column;
				/* Добавляем fallback для старых браузеров */
				min-height: 100vh;
			}

			/* === ШАПКА ТОЛЬКО НА ДЕСКТОПЕ === */
			.desktop-header {
				display: none;
				background: rgba(30, 41, 59, 0.95);
				padding: 1rem 2rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			}

			.header-content {
				max-width: 1200px;
				margin: 0 auto;
				display: flex;
				justify-content: space-between;
				align-items: center;
				width: 100%;
			}

			.header-title {
				display: flex;
				align-items: center;
				gap: 0.75rem;
			}

			.room-id-display {
				background: rgba(255, 255, 255, 0.1);
				padding: 0.5rem 1rem;
				border-radius: 8px;
				font-family: monospace;
				font-size: 0.9rem;
			}

			/* === МОБИЛЬНАЯ ШАПКА === */
			.mobile-header {
				display: none;
				background: rgba(30, 41, 59, 0.95);
				padding: 0.75rem 1rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				position: fixed; /* ВАЖНОЕ ИЗМЕНЕНИЕ: fixed вместо sticky */
				top: 0;
				left: 0;
				right: 0;
				z-index: 100;
				backdrop-filter: blur(10px);
				height: 50px; /* Фиксированная высота для корректного отступа */
			}

			.mobile-header-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.mobile-status {
				font-size: 0.9rem;
				color: #94a3b8;
			}

			/* === ОСНОВНОЙ КОНТЕНТ === */
			.main-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				height: 100vh; /* Для десктопа оставляем 100vh */
			}

			/* === ВИДЕО СЕКЦИЯ === */
			.video-section {
				flex: 1;
				background: #000;
				position: relative;
				min-height: 40vh;
			}

			#remote-video {
				width: 100%;
				height: 100%;
				object-fit: contain;
				background: #000;
			}

			.video-placeholder {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				background: #0f172a;
				color: #94a3b8;
				text-align: center;
				padding: 2rem;
			}

			.video-placeholder i {
				font-size: 3rem;
				margin-bottom: 1rem;
			}

			.video-controls {
				position: absolute;
				bottom: 1rem;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				gap: 0.75rem;
				background: rgba(0, 0, 0, 0.7);
				padding: 0.75rem;
				border-radius: 50px;
				backdrop-filter: blur(10px);
				z-index: 50;
				opacity: 0;
				transition: opacity 0.3s ease;
				pointer-events: none;
			}

			.video-controls.visible {
				opacity: 1;
				pointer-events: auto;
			}

			.control-btn {
				width: 50px;
				height: 50px;
				border-radius: 50%;
				border: none;
				background: rgba(255, 255, 255, 0.15);
				color: white;
				font-size: 1.25rem;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.2s ease;
			}

			.control-btn:active {
				transform: scale(0.95);
				background: rgba(255, 255, 255, 0.25);
			}

			.control-btn.active {
				background: #10b981;
			}

			/* === ЧАТ СЕКЦИЯ === */
			.chat-section {
				height: 40vh;
				min-height: 250px;
				background: #1e293b;
				border-top: 1px solid rgba(255, 255, 255, 0.1);
				display: flex;
				flex-direction: column; /* ВАЖНО: Flex для правильного скролла */
			}

			.chat-header {
				padding: 1rem;
				background: rgba(30, 41, 59, 0.95);
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				display: flex;
				justify-content: space-between;
				align-items: center;
				flex-shrink: 0; /* Шапка чата не сжимается */
			}

			.chat-header h3 {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				font-size: 1rem;
			}

			.online-count {
				background: rgba(16, 185, 129, 0.2);
				color: #10b981;
				padding: 0.25rem 0.75rem;
				border-radius: 20px;
				font-size: 0.8rem;
			}

			.chat-messages {
				flex: 1; /* ВАЖНО: Занимает все доступное место */
				overflow-y: auto; /* ВАЖНО: Обеспечивает скролл */
				padding: 1rem;
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
				scrollbar-width: thin;
				scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
			}

			.chat-messages::-webkit-scrollbar {
				width: 6px;
			}

			.chat-messages::-webkit-scrollbar-track {
				background: transparent;
			}

			.chat-messages::-webkit-scrollbar-thumb {
				background: rgba(255, 255, 255, 0.2);
				border-radius: 3px;
			}

			.message {
				padding: 0.75rem 1rem;
				border-radius: 12px;
				word-wrap: break-word;
				animation: fadeIn 0.3s ease;
			}

			.message.system {
				background: rgba(59, 130, 246, 0.2);
				border: 1px solid rgba(59, 130, 246, 0.3);
				color: #3b82f6;
				text-align: center;
				max-width: 100%;
				font-size: 0.9rem;
				padding: 0.5rem;
			}

			.message.local {
				background: rgba(16, 185, 129, 0.2);
				border: 1px solid rgba(16, 185, 129, 0.3);
				color: #10b981;
				margin-right: 0;
			}

			.message.remote {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				color: white;
			}

			.message-sender {
				font-weight: 600;
				font-size: 0.85rem;
				margin-bottom: 0.25rem;
				opacity: 0.9;
			}

			.message-time {
				font-size: 0.75rem;
				opacity: 0.7;
				margin-top: 0.25rem;
				text-align: right;
			}

			.chat-input-area {
				padding: 1rem;
				border-top: 1px solid rgba(255, 255, 255, 0.1);
				display: flex;
				gap: 0.75rem;
				background: rgba(30, 41, 59, 0.95);
				flex-shrink: 0; /* Поле ввода не сжимается */
			}

			#chat-input {
				flex: 1;
				padding: 0.75rem 1rem;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 25px;
				color: white;
				font-size: 1rem;
				outline: none;
			}

			#chat-input:focus {
				border-color: #3b82f6;
			}

			.send-btn {
				width: 50px;
				height: 50px;
				border-radius: 50%;
				border: none;
				background: linear-gradient(135deg, #3b82f6, #2563eb);
				color: white;
				font-size: 1.25rem;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.2s ease;
			}

			.send-btn:active {
				transform: scale(0.95);
			}

			/* === ЭКРАН ПОДКЛЮЧЕНИЯ === */
			/* ... (Оставляем как было, он находится поверх всего) ... */

			.connect-screen {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: #0f172a;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				padding: 2rem;
				z-index: 1000;
			}

			.connect-content {
				max-width: 400px;
				width: 100%;
				text-align: center;
			}

			.connect-icon {
				width: 80px;
				height: 80px;
				background: linear-gradient(135deg, #3b82f6, #8b5cf6);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				margin: 0 auto 2rem;
				font-size: 2rem;
			}

			.connect-title {
				font-size: 1.75rem;
				margin-bottom: 1rem;
				background: linear-gradient(135deg, #3b82f6, #8b5cf6);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
			}

			.connect-input {
				width: 100%;
				padding: 1rem;
				margin-bottom: 1rem;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 12px;
				color: white;
				font-size: 1.1rem;
				text-align: center;
				text-transform: uppercase;
			}

			.connect-input::placeholder {
				color: #94a3b8;
				text-transform: none;
			}

			.connect-btn {
				width: 100%;
				padding: 1rem;
				background: linear-gradient(135deg, #3b82f6, #2563eb);
				color: white;
				border: none;
				border-radius: 12px;
				font-size: 1.1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				margin-bottom: 1rem;
			}

			.connect-btn:active {
				transform: scale(0.98);
			}

			.status-message {
				padding: 0.75rem;
				border-radius: 8px;
				margin-top: 1rem;
				font-size: 0.9rem;
			}

			.status-message.error {
				background: rgba(239, 68, 68, 0.2);
				border: 1px solid rgba(239, 68, 68, 0.3);
				color: #ef4444;
			}

			/* === ПОЛНОЭКРАННЫЙ РЕЖИМ (Контролы) === */
			.fullscreen-controls {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				padding: 1rem;
				background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
				display: flex;
				justify-content: space-between;
				align-items: center;
				z-index: 100;

				/* ИСПРАВЛЕНИЕ 1: Кликабельность кнопки чата */
				opacity: 0.2;
				transition: opacity 0.3s ease;
				pointer-events: auto;
			}

			/* При активности делаем их полностью видимыми */
			.fullscreen-controls.visible {
				opacity: 1;
			}

			/* На мобільних екранах можна зробити ще менш помітними у стані спокою */
			@media (max-width: 767px), (max-width: 1024px) and (orientation: landscape) {
				.fullscreen-controls {
					opacity: 0.1;
				}
			}

			.back-btn {
				width: 44px;
				height: 44px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.5);
				border: none;
				color: white;
				font-size: 1.25rem;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				backdrop-filter: blur(10px);
			}

			/* === НОВЫЕ СТИЛИ ДЛЯ ПОЛНОЭКРАННОГО ЧАТА (В СТИЛЕ GTA V) === */

			/* Контейнер, который будет плавать поверх видео */
			#fullscreenChat {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				z-index: 90;
				pointer-events: none;
				display: none;
			}

			#fullscreenChat.active {
				display: block;
			}

			/* Фактический контейнер чата (узкая колонка в углу) */
			.fs-chat-container {
				position: absolute;
				top: 4rem;
				left: 1rem;
				width: 300px;
				max-height: 80%;

				background: rgba(0, 0, 0, 0.4);
				border-radius: 8px;
				padding: 0.5rem;
				backdrop-filter: blur(5px);

				display: flex;
				flex-direction: column;
				overflow: hidden;

				transition: transform 0.3s ease-out;
				transform: translateX(0);

				pointer-events: auto;
				justify-content: space-between;
			}

			/* Скрываем/показываем чат (если захотите его прятать кнопкой) */
			.fs-chat-container.hidden {
				transform: translateX(-150%);
			}

			/* Сообщения в полноэкранном чате */
			.fs-chat-messages {
				flex-grow: 1;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				justify-content: flex-end;
				gap: 0.25rem;
				padding: 0.5rem 0.75rem;
				max-height: 300px;
				scrollbar-width: none;
			}

			.fs-chat-messages::-webkit-scrollbar {
				display: none;
			}

			.fs-chat-messages .message {
				padding: 0;
				border-radius: 0;
				max-width: 100%;
				margin-right: auto;

				background: transparent !important;
				border: none !important;
				color: white !important;
				font-size: 0.9rem;
			}

			.fs-chat-messages .message-sender {
				font-weight: 700;
				display: inline;
				margin-right: 0.5rem;

				color: #fca311;
			}

			.fs-chat-messages .message.local .message-sender {
				color: #10b981;
			}

			.fs-chat-messages .message-text {
				display: inline;
			}

			.fs-chat-messages .message-time,
			.fs-chat-messages .message.system {
				display: none !important;
			}

			/* Поле ввода в полноэкранном режиме */
			.fs-chat-input-area {
				padding: 0.5rem;
				display: flex;
				gap: 0.5rem;
				border-top: 1px solid rgba(255, 255, 255, 0.1);
			}

			.fs-chat-input-area input {
				flex-grow: 1;
				padding: 0.5rem 0.75rem;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 4px;
				color: white;
				font-size: 0.9rem;
				outline: none;
			}

			.fs-chat-input-area .send-btn {
				width: 40px;
				height: 40px;
				font-size: 1rem;
			}

			/* Контейнер для кнопки переключения чата и ID комнаты */
			.fs-controls-right {
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			/* Стили для кнопки переключения чата */
			.fs-chat-toggle-btn {
				width: 44px;
				height: 44px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.5);
				border: none;
				color: white;
				font-size: 1.25rem;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				backdrop-filter: blur(10px);
				transition: background 0.2s;
			}

			.fs-chat-toggle-btn:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			.fs-chat-toggle-btn.hidden {
				display: none;
			}

			.controlls {
				display: flex;
				flex-direction: row;
				gap: 5px;
			}

			/* === СТИЛЬ УВЕДОМЛЕНИЯ НА КНОПКЕ ЧАТА === */
			@keyframes pulse {
				0% {
					box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
				}
				70% {
					box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
				}
				100% {
					box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
				}
			}

			.fs-chat-toggle-btn.has-new-message {
				background: #ef4444;
				animation: pulse 1s infinite;
			}

			/* === АДАПТИВНОСТЬ (ДЕСКТОП) === */
			@media (min-width: 768px) {
				.desktop-header {
					display: block;
				}

				.mobile-header {
					display: none !important;
				}

				.main-content {
					flex-direction: row;
					width: 100%;
					height: 100vh; /* Возвращаем 100vh для десктопа */
					padding-top: 0; /* Убираем отступ, если desktop-header не fixed */
				}

				.video-section {
					flex: 2;
					height: calc(100vh - 60px); /* Учитываем высоту desktop-header */
					min-height: auto;
				}

				.chat-section {
					flex: 1;
					height: calc(100vh - 60px);
					min-height: auto;
					max-width: 400px;
				}

				.video-controls {
					bottom: 2rem;
				}

				.control-btn {
					width: 56px;
					height: 56px;
					font-size: 1.5rem;
				}
			}

			/* === АДАПТИВНОСТЬ (МОБИЛЬНЫЙ РЕЖИМ) === */
			@media (max-width: 767px) {
				.mobile-header {
					display: block;
				}

				.main-content {
					/* ИСПРАВЛЕНИЕ 2: Занимаем всю видимую область, чтобы Flex работал надежно */
					height: auto;
					min-height: 100vh;
					position: absolute;
					top: 0;
					bottom: 0;
					left: 0;
					right: 0;
					padding-top: 50px; /* Отступ от fixed mobile-header */
					flex-direction: column;
				}

				.video-section {
					/* ИСПРАВЛЕНИЕ 3: Фиксированная высота для предсказуемости */
					height: 40vh;
					min-height: auto;
					flex-grow: 0;
					flex-shrink: 0;
				}

				#remote-video {
					width: 100%;
					height: 100%; /* Теперь заполняет 40vh родителя */
					object-fit: contain;
				}

				.video-placeholder {
					position: absolute;
					height: auto; /* Заполняет родителя */
				}

				.chat-section {
					/* ИСПРАВЛЕНИЕ 4: Занимает весь оставшийся вертикальный контейнер */
					flex-grow: 1;
					height: auto;
					min-height: 250px;
				}

				.video-controls {
					bottom: 0.5rem;
					gap: 0.5rem;
					padding: 0.5rem;
				}

				.control-btn {
					width: 44px;
					height: 44px;
					font-size: 1.1rem;
				}

				.chat-input-area {
					padding: 0.75rem;
					flex-shrink: 0; /* Гарантируем, что поле ввода не сжимается */
				}

				#chat-input {
					padding: 0.75rem;
					font-size: 0.95rem;
				}

				.send-btn {
					width: 44px;
					height: 44px;
					font-size: 1.1rem;
				}
			}

			/* Мобильная коррекция для полноэкранного чата */
			@media (max-width: 767px), (max-width: 1024px) and (orientation: landscape) {
				.fs-chat-container {
					top: 4.5rem;
					left: 1rem;
				}
			}

			/* === АНИМАЦИИ === */
			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			/* ... (УТИЛИТЫ) ... */
			.hidden {
				display: none !important;
			}

			.loading {
				animation: pulse 1.5s infinite;
			}

			i {
				font-style: normal;
			}

			/* Дополнительные стили для touch устройств */
			@media (hover: none) and (pointer: coarse) {
				.control-btn,
				.send-btn,
				.back-btn {
					min-height: 44px;
					min-width: 44px;
				}

				input,
				button {
					font-size: 16px;
				}
			}

			#controlBtns {
				display: flex;
				gap: 5px;
			}
		</style>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
	</head>
	<body>
		<header class="desktop-header">
			<div class="header-content">
				<div class="header-title">
					<i class="fas fa-eye"></i>
					<h2>Перегляд трансляції</h2>
				</div>
				<div class="room-id-display" id="desktopRoomId">—</div>
				<div class="header-status" id="desktopStatus">Підключення...</div>
			</div>
		</header>

		<header class="mobile-header hidden">
			<div class="mobile-header-content">
				<div class="mobile-status" id="mobileStatus">
					<i class="fas fa-signal"></i> Підключення...
				</div>
				<div class="room-id-display" id="mobileRoomId">—</div>
			</div>
		</header>

		<div id="connectScreen" class="connect-screen">
			<div class="connect-content">
				<div class="connect-icon">
					<i class="fas fa-video"></i>
				</div>
				<h1 class="connect-title">Перегляд трансляції</h1>
				<p style="color: #94a3b8; margin-bottom: 2rem">
					Введіть ID кімнати, щоб приєднатися до трансляції
				</p>

				<input
					type="text"
					id="roomIdInput"
					class="connect-input"
					placeholder="ID кімнати"
					maxlength="10"
				/>

				<button onclick="joinRoom()" class="connect-btn">
					<i class="fas fa-play"></i> Підключитися
				</button>

				<div id="connectStatus" class="status-message"></div>

				<div style="margin-top: 2rem; font-size: 0.9rem; color: #64748b">
					<i class="fas fa-info-circle"></i> Запитайте ID кімнати у хоста
				</div>
			</div>
		</div>

		<div id="roomContent" class="main-content hidden">
			<section class="video-section">
				<video id="remote-video" autoplay playsinline></video>

				<div id="videoPlaceholder" class="video-placeholder">
					<i class="fas fa-spinner fa-spin"></i>
					<h3>Очікування трансляції...</h3>
					<p>Хост скоро розпочне трансляцію</p>
				</div>

				<div class="video-controls">
					<button id="fullscreenBtn" class="control-btn" title="Повноекранний режим">
						<i class="fas fa-expand"></i>
					</button>
					<button id="audioBtn" class="control-btn active" title="Звук увімк./вимк.">
						<i class="fas fa-volume-up"></i>
					</button>
				</div>

				<div id="fullscreenControls" class="fullscreen-controls">
					<div id="controlBtns">
						<button class="back-btn" onclick="exitFullscreen()">
							<i class="fas fa-arrow-left"></i>
						</button>
						<button
							id="fsChatToggleBtn"
							class="fs-chat-toggle-btn"
							title="Показати/Сховати чат"
						>
							<i class="fas fa-comment"></i>
						</button>
					</div>

					<div class="fs-controls-right">
						<div class="room-id-display" id="fullscreenRoomId">—</div>
					</div>
				</div>
			</section>

			<section class="chat-section">
				<div class="chat-header">
					<h3><i class="fas fa-comments"></i> Чат</h3>
					<div class="online-count" id="onlineCount">1 онлайн</div>
				</div>

				<div class="chat-messages" id="messages">
					<div class="message system">
						<i class="fas fa-spinner fa-spin"></i> Підключення до чату...
					</div>
				</div>

				<div class="chat-input-area">
					<input
						type="text"
						id="chat-input"
						class="chat-input"
						placeholder="Напишіть повідомлення..."
						maxlength="500"
					/>
					<button onclick="sendMessage()" class="send-btn">
						<i class="fas fa-paper-plane"></i>
					</button>
				</div>
			</section>
		</div>

		<div id="fullscreenChat">
			<div class="fs-chat-container">
				<div class="fs-chat-messages" id="fsMessages"></div>
				<div class="fs-chat-input-area">
					<input
						type="text"
						id="fs-chat-input"
						placeholder="Напишіть повідомлення..."
						maxlength="500"
					/>
					<button onclick="sendFullscreenMessage()" class="send-btn">
						<i class="fas fa-paper-plane"></i>
					</button>
				</div>
			</div>
		</div>

		<div id="fullscreenChatAnchor" class="hidden"></div>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			// === DOM Elements & Globals ===
			const configuration = {
				iceServers: [
					{ urls: "stun:stun.l.google.com:19302" },
					{ urls: "stun:stun1.l.google.com:19302" },
					{ urls: "stun:stun2.l.google.com:19302" },
					{ urls: "stun:stun3.l.google.com:19302" },
					{ urls: "stun:stun4.l.google.com:19302" },
					{ urls: "stun:stun.voiparound.com" },
					{ urls: "stun:stun.voipbuster.com" },
					{ urls: "stun:stun.voipstunt.com" },
				],
			};
			const socket = io();
			let ROOM_ID;
			let peerConnection;
			let dataChannel;
			let HOST_ID;
			let isFullscreen = false;
			let onlineCount = 1;

			// New/Updated DOM Elements
			const videoSection = document.querySelector(".video-section");
			const fullscreenChat = document.getElementById("fullscreenChat");
			const fullscreenChatAnchor = document.getElementById("fullscreenChatAnchor");
			const fsMessagesDiv = document.getElementById("fsMessages");
			const fsChatInput = document.getElementById("fs-chat-input");
			const videoControls = document.querySelector(".video-controls"); // Нижние контролы
			const fullscreenControls = document.getElementById("fullscreenControls"); // Верхние контролы
			const fsChatToggleBtn = document.getElementById("fsChatToggleBtn"); // Кнопка переключения чата

			let controlsTimeout; // Для таймера скрытия контролов

			// === ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ ИНТЕРФЕЙСА ===

			function updateStatus(status, type = "info") {
				document.getElementById("desktopStatus").textContent = status;
				document.getElementById(
					"mobileStatus"
				).innerHTML = `<i class="fas fa-signal"></i> ${status}`;

				if (type === "error") {
					document.getElementById("mobileStatus").style.color = "#ef4444";
				} else if (type === "success") {
					document.getElementById("mobileStatus").style.color = "#10b981";
				} else {
					document.getElementById("mobileStatus").style.color = "#94a3b8";
				}
			}

			function updateRoomId(roomId) {
				document.getElementById("desktopRoomId").textContent = roomId;
				document.getElementById("mobileRoomId").textContent = roomId;
				document.getElementById("fullscreenRoomId").textContent = roomId;
			}

			function updateOnlineCount(count) {
				onlineCount = count;
				const text = count === 1 ? "1 онлайн" : `${count} онлайн`;
				document.getElementById("onlineCount").textContent = text;
			}

			function showRoomInterface() {
				document.getElementById("connectScreen").classList.add("hidden");
				document.getElementById("roomContent").classList.remove("hidden");
				document.querySelector(".mobile-header").classList.remove("hidden");
			}

			// --- ЛОГИКА АВТОСКРЫТИЯ КОНТРОЛОВ ---

			function showControls() {
				// В обычном режиме показываем только нижнюю панель
				if (!document.fullscreenElement) {
					videoControls.classList.add("visible");
				} else {
					// В полноэкранном режиме показываем обе панели
					videoControls.classList.add("visible");
					fullscreenControls.classList.add("visible");
				}

				// Сбрасываем предыдущий таймер
				clearTimeout(controlsTimeout);

				// Устанавливаем новый таймер на скрытие через 3 секунды
				controlsTimeout = setTimeout(() => {
					hideControls();
				}, 3000);
			}

			function hideControls() {
				videoControls.classList.remove("visible");
				fullscreenControls.classList.remove("visible");
			}

			// --- ОБНОВЛЕННЫЕ ФУНКЦИИ FULLSCREEN ---

			function toggleFullscreen() {
				if (!document.fullscreenElement) {
					// *** 1. ВХОД: Перемещаем чат в video-section (для видимости) ***
					videoSection.appendChild(fullscreenChat);

					if (videoSection.requestFullscreen) {
						videoSection.requestFullscreen();
					} else if (videoSection.webkitRequestFullscreen) {
						videoSection.webkitRequestFullscreen();
					} else if (videoSection.mozRequestFullScreen) {
						videoSection.mozRequestFullScreen();
					}

					fullscreenChat.classList.add("active"); // Показываем чат
					copyChatMessagesToFullscreen(); // Синхронизируем сообщения
				} else {
					exitFullscreen();
				}
			}

			function exitFullscreen() {
				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.webkitExitFullscreen) {
					document.webkitExitFullscreen();
				} else if (document.mozCancelFullScreen) {
					document.mozCancelFullScreen();
				}
				// Логика возврата чата и скрытия контролов происходит в обработчике 'fullscreenchange'
			}

			// Обработка выхода/входа из полноэкранного режима
			document.addEventListener("fullscreenchange", () => {
				isFullscreen = !!document.fullscreenElement;

				if (isFullscreen) {
					// При входе показываем контролы и запускаем таймер
					showControls();
				} else {
					// *** 2. ВЫХОД: Возвращаем чат на место (к якорю) ***
					fullscreenChatAnchor.appendChild(fullscreenChat);
					fullscreenChat.classList.remove("active"); // Скрываем чат
					hideControls(); // Скрываем контролы
				}
			});

			// *** НОВАЯ/ОБНОВЛЕННАЯ ФУНКЦИЯ ДЛЯ ПЕРЕКЛЮЧЕНИЯ ЧАТА ***
			function toggleFullscreenChat() {
				const fsChatContainer = document.querySelector(".fs-chat-container");
				const isHidden = fsChatContainer.classList.toggle("hidden");

				// Снимаем уведомление при открытии чата
				if (!isHidden) {
					fsChatToggleBtn.classList.remove("has-new-message");
					fsChatInput.focus();
				}
			}

			// === ФУНКЦИИ ЧАТА ===

			function sendMessage() {
				const messageInput = document.getElementById("chat-input");
				const message = messageInput.value.trim();
				if (message === "" || !dataChannel || dataChannel.readyState !== "open") return;

				dataChannel.send(JSON.stringify({ type: "chat", message, sender: "Participant" }));
				displayMessage(message, "local", "Я");
				messageInput.value = "";
			}

			function sendFullscreenMessage() {
				const message = fsChatInput.value.trim();
				if (message === "" || !dataChannel || dataChannel.readyState !== "open") return;

				dataChannel.send(JSON.stringify({ type: "chat", message, sender: "Participant" }));

				// Отправляем в основной чат (который автоматически скопирует его в полноэкранный)
				displayMessage(message, "local", "Я");

				fsChatInput.value = "";
			}

			function displayMessage(text, type, sender = "Хост") {
				const messagesDiv = document.getElementById("messages");

				// Убираем сообщение о загрузке если оно есть
				const loadingMsg = messagesDiv.querySelector(".system");
				if (loadingMsg && loadingMsg.innerHTML.includes("fa-spinner")) {
					loadingMsg.remove();
				}

				const msg = document.createElement("div");
				msg.className = `message ${type}`;

				const time = new Date().toLocaleTimeString([], {
					hour: "2-digit",
					minute: "2-digit",
				});

				msg.innerHTML = `
			${type !== "system" ? `<div class="message-sender">${sender}</div>` : ""}
			<div class="message-text">${text}</div>
			<div class="message-time">${time}</div>
		`;

				messagesDiv.appendChild(msg);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;

				// *** КОПИРОВАНИЕ В ПОЛНОЭКРАННЫЙ ЧАТ ***
				if (fullscreenChat.classList.contains("active") && type !== "system") {
					copyMessageToFullscreen(text, type, sender);
				}
			}

			function copyMessageToFullscreen(text, type, sender) {
				const fsMsg = document.createElement("div");
				fsMsg.className = `message ${type}`;

				const senderName = type === "local" ? "Я" : sender;

				fsMsg.innerHTML = `
					<div class="message-sender">${senderName}:</div>
					<div class="message-text">${text}</div>
				`;

				// Ограничиваем количество сообщений (например, последние 10)
				if (fsMessagesDiv.children.length >= 6) {
					fsMessagesDiv.removeChild(fsMessagesDiv.children[0]);
				}

				fsMessagesDiv.appendChild(fsMsg);
				fsMessagesDiv.scrollTop = fsMessagesDiv.scrollHeight;
			}

			function copyChatMessagesToFullscreen() {
				fsMessagesDiv.innerHTML = ""; // Очищаем
				// Выбираем только не-системные сообщения
				const mainMessages = document
					.getElementById("messages")
					.querySelectorAll(".message:not(.system)");

				mainMessages.forEach((msg) => {
					const type = msg.classList.contains("local") ? "local" : "remote";
					// Пытаемся получить имя отправителя
					const senderElement = msg.querySelector(".message-sender");
					let sender = senderElement
						? senderElement.textContent.trim()
						: type === "local"
						? "Я"
						: "Хост";

					const text = msg.querySelector(".message-text")
						? msg.querySelector(".message-text").textContent
						: "...";

					copyMessageToFullscreen(text, type, sender);
				});
			}

			// === WEB RTC И SOCKET.IO ЛОГИКА (ОБНОВЛЕН ОБРАБОТЧИК dataChannel.onmessage) ===

			async function createPeerConnection(hostId) {
				peerConnection = new RTCPeerConnection(configuration);
				HOST_ID = hostId;

				peerConnection.ontrack = (event) => {
					const remoteVideo = document.getElementById("remote-video");
					if (remoteVideo.srcObject !== event.streams[0]) {
						remoteVideo.srcObject = event.streams[0];
						console.log("Remote stream added.");
						document.getElementById("videoPlaceholder").classList.add("hidden");
						updateStatus("Трансляція активна", "success");
					}
				};

				peerConnection.ondatachannel = (event) => {
					dataChannel = event.channel;
					dataChannel.onopen = () => {
						console.log("Data Channel is open!");
						displayMessage("Чат підключено", "system");
					};
					dataChannel.onmessage = (event) => {
						const data = JSON.parse(event.data);
						if (data.type === "chat") {
							displayMessage(data.message, "remote", "Хост");

							// *** ЛОГИКА УВЕДОМЛЕНИЯ ***
							const fsChatContainer = document.querySelector(".fs-chat-container");
							// Если в полноэкранном режиме И чат скрыт
							if (
								document.fullscreenElement &&
								fsChatContainer.classList.contains("hidden")
							) {
								fsChatToggleBtn.classList.add("has-new-message");
							}
						}
					};
				};

				peerConnection.onicecandidate = ({ candidate }) => {
					if (candidate) {
						socket.emit("signal", {
							roomId: ROOM_ID,
							targetId: HOST_ID,
							signalType: "ice",
							data: candidate,
						});
					}
				};

				peerConnection.onconnectionstatechange = () => {
					console.log("Состояние соединения:", peerConnection.connectionState);
					if (
						peerConnection.connectionState === "disconnected" ||
						peerConnection.connectionState === "failed"
					) {
						updateStatus("Втрачено зв'язок", "error");
						displayMessage("Втрачено зв'язок з трансляцією", "system");
					}
				};

				return peerConnection;
			}

			async function handleSignal(data) {
				const { senderId, signalType, data: signalData } = data;

				if (signalType === "sdp" && signalData.type === "offer") {
					if (!peerConnection) {
						await createPeerConnection(senderId);
					}
					updateStatus("Підключення до трансляції...");

					await peerConnection.setRemoteDescription(
						new RTCSessionDescription(signalData)
					);

					const answer = await peerConnection.createAnswer();
					await peerConnection.setLocalDescription(answer);

					socket.emit("signal", {
						roomId: ROOM_ID,
						targetId: senderId,
						signalType: "sdp",
						data: peerConnection.localDescription,
					});
				} else if (signalType === "ice") {
					if (peerConnection) {
						await peerConnection.addIceCandidate(new RTCIceCandidate(signalData));
					}
				}
			}

			function joinRoom() {
				ROOM_ID = document.getElementById("roomIdInput").value.trim().toUpperCase();
				if (!ROOM_ID) {
					showConnectError("Будь ласка, введіть ID кімнати.");
					return;
				}

				updateStatus("Підключення...");
				socket.emit("join_room", ROOM_ID);
				showConnectStatus("Підключення до кімнати...");
			}

			function showConnectStatus(message) {
				const statusDiv = document.getElementById("connectStatus");
				statusDiv.textContent = message;
				statusDiv.className = "status-message";
			}

			function showConnectError(message) {
				const statusDiv = document.getElementById("connectStatus");
				statusDiv.textContent = message;
				statusDiv.className = "status-message error";
			}

			// === НАСТРОЙКА СОБЫТИЙ ===

			// 1. События движения мыши/тапа для видео секции (для показа контролов)
			videoSection.addEventListener("mousemove", showControls);
			videoSection.addEventListener("touchstart", showControls);
			videoSection.addEventListener("touchmove", showControls);

			document.getElementById("roomIdInput").addEventListener("keypress", (e) => {
				if (e.key === "Enter") joinRoom();
			});

			document.getElementById("chat-input").addEventListener("keypress", (e) => {
				if (e.key === "Enter") sendMessage();
			});

			// НОВЫЙ ОБРАБОТЧИК ДЛЯ ПОЛНОЭКРАННОГО ЧАТА
			fsChatInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter") sendFullscreenMessage();
			});

			// ОБРАБОТЧИК ДЛЯ ПЕРЕКЛЮЧЕНИЯ ПОЛНОЭКРАННОГО ЧАТА
			fsChatToggleBtn.addEventListener("click", toggleFullscreenChat);

			document.getElementById("fullscreenBtn").addEventListener("click", toggleFullscreen);

			document.getElementById("audioBtn").addEventListener("click", () => {
				const video = document.getElementById("remote-video");
				if (video) {
					video.muted = !video.muted;
					const btn = document.getElementById("audioBtn");
					btn.classList.toggle("active", !video.muted);
					btn.innerHTML = video.muted
						? '<i class="fas fa-volume-mute"></i>'
						: '<i class="fas fa-volume-up"></i>';
				}
			});

			// === ОБРАБОТЧИКИ SOCKET.IO ===

			socket.on("connect", () => {
				console.log("Connected to signaling server.");
			});

			socket.on("room_error", (msg) => {
				showConnectError(`Помилка: ${msg}`);
				updateStatus("Помилка підключення", "error");
			});

			socket.on("room_ready", () => {
				showRoomInterface();
				updateRoomId(ROOM_ID);
				updateStatus("Підключено до кімнати");
				updateOnlineCount(2); // Хост + зритель
				displayMessage("Ви підключилися до кімнати", "system");
			});

			socket.on("signal", handleSignal);

			socket.on("host_disconnected", (msg) => {
				showConnectError("Хост відключився");
				updateStatus("Хост відключився", "error");
				displayMessage("Хост завершив трансляцію", "system");
				setTimeout(() => {
					location.reload();
				}, 3000);
			});

			socket.on("participant_joined", () => {
				updateOnlineCount(onlineCount + 1);
				displayMessage("Новий глядач приєднався", "system");
			});

			socket.on("participant_left", () => {
				updateOnlineCount(Math.max(1, onlineCount - 1));
				displayMessage("Глядач вийшов", "system");
			});

			// === ИНИЦИАЛИЗАЦИЯ ===

			// Автофокус на поле ввода при загрузке
			window.addEventListener("load", () => {
				document.getElementById("roomIdInput").focus();

				// Показываем мобильную шапку только после подключения
				if (window.innerWidth <= 767) {
					document.querySelector(".mobile-header").classList.add("hidden");
				}

				// Инициализируем якорь чата (перемещаем чат в якорь)
				fullscreenChatAnchor.appendChild(fullscreenChat);

				// Показываем контролы в обычном режиме (если не в режиме подключения)
				if (!document.getElementById("connectScreen").classList.contains("hidden")) {
					showControls();
				}
			});
		</script>
	</body>
</html>
