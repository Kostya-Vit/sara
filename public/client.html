<!DOCTYPE html>
<html lang="uk">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Учасник | Перегляд Трансляції</title>
		<style>
			/* === ТОТ ЖЕ СТИЛЬ ЧТО И ДЛЯ HOST.HTML === */

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
				background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
				color: white;
				min-height: 100vh;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem;
			}

			h1 {
				text-align: center;
				margin-bottom: 2rem;
				color: #3b82f6;
				font-size: 2.5rem;
			}

			#setup {
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 12px;
				padding: 2rem;
				margin-bottom: 2rem;
				text-align: center;
			}

			#room-id-input {
				width: 100%;
				padding: 1rem;
				font-size: 1.1rem;
				margin-bottom: 1rem;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 8px;
				color: white;
			}

			button {
				padding: 1rem 2rem;
				background: linear-gradient(135deg, #3b82f6, #2563eb);
				color: white;
				border: none;
				border-radius: 8px;
				font-size: 1.1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
			}

			#status {
				background: rgba(59, 130, 246, 0.1);
				border: 1px solid rgba(59, 130, 246, 0.2);
				border-radius: 12px;
				padding: 1.5rem;
				margin-bottom: 2rem;
				text-align: center;
			}

			.room-interface {
				display: none;
				gap: 2rem;
			}

			#video-area {
				flex: 2;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 12px;
				padding: 1.5rem;
			}

			#remote-video {
				width: 100%;
				height: 500px;
				background: #0f172a;
				border-radius: 8px;
				object-fit: contain;
			}

			#chat-interface {
				flex: 1;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 12px;
				padding: 1.5rem;
				display: flex;
				flex-direction: column;
			}

			#messages {
				flex: 1;
				overflow-y: auto;
				margin-bottom: 1rem;
				padding: 1rem;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 8px;
				min-height: 300px;
			}

			.message {
				padding: 0.75rem 1rem;
				margin-bottom: 0.75rem;
				border-radius: 8px;
				max-width: 80%;
			}

			.message.local {
				background: rgba(16, 185, 129, 0.2);
				border: 1px solid rgba(16, 185, 129, 0.3);
				margin-left: auto;
			}

			.message.remote {
				background: rgba(59, 130, 246, 0.2);
				border: 1px solid rgba(59, 130, 246, 0.3);
			}

			#chat-input-area {
				display: flex;
				gap: 0.5rem;
			}

			#chat-input {
				flex: 1;
				padding: 0.75rem;
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 8px;
				color: white;
			}

			/* === КОНЕЦ СТИЛЕЙ === */
		</style>
	</head>
	<body>
		<!-- ВАШ РАБОЧИЙ HTML БЕЗ ИЗМЕНЕНИЙ -->
		<div class="container" id="control-area">
			<h1>Учасник: Перегляд Екрана та Чат</h1>

			<div id="setup">
				<input type="text" id="room-id-input" placeholder="Введіть ID кімнати" />
				<button onclick="joinRoom()">Підключитися до Кімнати</button>
			</div>

			<p id="status" style="display: none">Статус: Очікування трансляції...</p>
		</div>

		<div class="container room-interface" style="display: none" id="room-area">
			<div id="video-area">
				<h2>Трансляція Хоста</h2>
				<video id="remote-video" autoplay playsinline></video>
			</div>

			<div id="chat-interface">
				<h2>Чат Кімнати</h2>
				<div id="messages"></div>
				<div id="chat-input-area">
					<input
						type="text"
						id="chat-input"
						placeholder="Ваше повідомлення..."
						onkeyup="if(event.key === 'Enter') sendMessage()"
					/>
					<button onclick="sendMessage()">Надіслати</button>
				</div>
			</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			// === ВАШ РАБОЧИЙ JAVASCRIPT БЕЗ ИЗМЕНЕНИЙ ===

			const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
			const socket = io();
			let ROOM_ID;
			let peerConnection;
			let dataChannel;
			let HOST_ID;

			function sendMessage() {
				const messageInput = document.getElementById("chat-input");
				const message = messageInput.value.trim();
				if (message === "" || !dataChannel || dataChannel.readyState !== "open") return;

				dataChannel.send(JSON.stringify({ type: "chat", message, sender: "Participant" }));
				displayMessage(message, "local", "Я");
				messageInput.value = "";
			}

			function displayMessage(text, type, sender = "Хост") {
				const messagesDiv = document.getElementById("messages");
				const msg = document.createElement("div");
				msg.className = `message ${type}`;
				msg.textContent = `${sender}: ${text}`;
				messagesDiv.appendChild(msg);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}

			async function createPeerConnection(hostId) {
				peerConnection = new RTCPeerConnection(configuration);
				HOST_ID = hostId;

				peerConnection.ontrack = (event) => {
					const remoteVideo = document.getElementById("remote-video");
					if (remoteVideo.srcObject !== event.streams[0]) {
						remoteVideo.srcObject = event.streams[0];
						console.log("Remote stream added.");
					}
					document.getElementById("status").textContent = "Трансляція активна.";
				};

				peerConnection.ondatachannel = (event) => {
					dataChannel = event.channel;
					dataChannel.onopen = () => console.log("Data Channel is open!");
					dataChannel.onmessage = (event) => {
						const data = JSON.parse(event.data);
						if (data.type === "chat") {
							displayMessage(data.message, "remote", "Хост");
						}
					};
				};

				peerConnection.onicecandidate = ({ candidate }) => {
					if (candidate) {
						socket.emit("signal", {
							roomId: ROOM_ID,
							targetId: HOST_ID,
							signalType: "ice",
							data: candidate,
						});
					}
				};

				return peerConnection;
			}

			async function handleSignal(data) {
				const { senderId, signalType, data: signalData } = data;

				if (signalType === "sdp" && signalData.type === "offer") {
					if (!peerConnection) {
						await createPeerConnection(senderId);
					}
					document.getElementById("status").textContent =
						"Отримано пропозицію... Надсилаємо відповідь.";

					await peerConnection.setRemoteDescription(
						new RTCSessionDescription(signalData)
					);

					const answer = await peerConnection.createAnswer();
					await peerConnection.setLocalDescription(answer);

					socket.emit("signal", {
						roomId: ROOM_ID,
						targetId: senderId,
						signalType: "sdp",
						data: peerConnection.localDescription,
					});
				} else if (signalType === "ice") {
					if (peerConnection) {
						await peerConnection.addIceCandidate(new RTCIceCandidate(signalData));
					}
				}
			}

			function joinRoom() {
				ROOM_ID = document.getElementById("room-id-input").value.trim();
				if (!ROOM_ID) {
					alert("Будь ласка, введіть ID кімнати.");
					return;
				}
				socket.emit("join_room", ROOM_ID);
				document.getElementById("status").style.display = "block";
				document.getElementById(
					"status"
				).textContent = `Спроба підключення до ${ROOM_ID}...`;
			}

			function setupRoomInterface() {
				document.getElementById("setup").style.display = "none";
				document.getElementById("room-area").style.display = "flex";
				document.getElementById("status").textContent =
					"Підключено до кімнати. Очікування трансляції...";
			}

			socket.on("connect", () => console.log("Connected to signaling server."));
			socket.on("room_error", (msg) => {
				document.getElementById("status").textContent = `Помилка: ${msg}`;
				alert(`Помилка кімнати: ${msg}`);
			});
			socket.on("room_ready", setupRoomInterface);
			socket.on("signal", handleSignal);
			socket.on("host_disconnected", (msg) => {
				alert(msg);
				location.reload();
			});

			// === КОНЕЦ ВАШЕГО РАБОЧЕГО КОДА ===
		</script>
	</body>
</html>
